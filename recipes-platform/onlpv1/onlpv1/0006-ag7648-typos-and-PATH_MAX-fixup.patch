From 2b6d4388f9dcaea61765d3280340c6977f35d653 Mon Sep 17 00:00:00 2001
From: Tobias Jungel <tobias.jungel@bisdn.de>
Date: Thu, 11 Apr 2019 13:41:53 +0200
Subject: [PATCH 06/12] ag7648: typos and PATH_MAX fixup

---
 .../onlp/builds/src/module/src/sfpi.c         |  2 +-
 .../onlp/builds/src/module/src/thermali.c     | 31 ++++++++++---------
 2 files changed, 17 insertions(+), 16 deletions(-)

diff --git a/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/sfpi.c b/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/sfpi.c
index cef32f7d..a8b7f29e 100755
--- a/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/sfpi.c
+++ b/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/sfpi.c
@@ -318,7 +318,7 @@ onlp_sfpi_eeprom_read(int port, uint8_t data[256])
 
 	if (port < SFP_PLUS_MIN_PORT || port > QSFP_MAX_PORT)
     {
-        AIM_LOG_ERROR("port %d is not invalid\r\n", port);
+        AIM_LOG_ERROR("port %d is not valid\r\n", port);
         return ONLP_STATUS_E_INVALID;
     }
     if (onlp_sfpi_is_present(port) <= 0)
diff --git a/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/thermali.c b/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/thermali.c
index fd3b9602..41ffaffd 100755
--- a/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/thermali.c
+++ b/packages/platforms/delta/x86-64/x86-64-delta-ag7648/onlp/builds/src/module/src/thermali.c
@@ -24,6 +24,7 @@
  *
  ***********************************************************/
 #include <unistd.h>
+#include <limits.h>
 #include <onlplib/mmap.h>
 #include <onlplib/file.h>
 #include <onlp/platformi/thermali.h>
@@ -61,7 +62,7 @@ static char* last_path[] =  /* must map with onlp_thermal_id */
     "3-004d/hwmon/hwmon3/temp1_input",
     "3-004e/hwmon/hwmon4/temp1_input",
 };
-	
+
 /* Static values */
 static onlp_thermal_info_t linfo[] = {
 	{ }, /* Not used */
@@ -111,7 +112,7 @@ _onlp_psu_thermali_val_to_temperature (int v,int mult)
  */
 int
 onlp_thermali_init(void)
-{ 
+{
     return ONLP_STATUS_OK;
 }
 
@@ -130,21 +131,21 @@ _onlp_thermali_info_get(int id, onlp_thermal_info_t* info)
 {
     int   len, nbytes = 10, temp_base=1, local_id;
     uint8_t r_data[10]={0};
-    char  fullpath[50] = {0};
+    char  fullpath[PATH_MAX] = {0};
 
     local_id = id;
-    
+
     DEBUG_PRINT("\n[Debug][%s][%d][local_id: %d]", __FUNCTION__, __LINE__, local_id);
     /* Set the onlp_oid_hdr_t and capabilities */
     *info = linfo[local_id];
     /* get fullpath */
-    sprintf(fullpath, "%s%s", prefix_path, last_path[local_id]);
+    snprintf(fullpath, PATH_MAX-1, "%s%s", prefix_path, last_path[local_id]);
 
     //OPEN_READ_FILE(fd, fullpath, r_data, nbytes, len);
     onlp_file_read(r_data,nbytes,&len, fullpath);
-    
+
     info->mcelsius =ONLPLIB_ATOI((char*)r_data) / temp_base;
-    
+
     DEBUG_PRINT("\n[Debug][%s][%d][save data: %d]\n", __FUNCTION__, __LINE__, info->mcelsius);
 
     return ONLP_STATUS_OK;
@@ -153,16 +154,16 @@ _onlp_thermali_info_get(int id, onlp_thermal_info_t* info)
 /*psu temperture info get*/
 static int
 _onlp_thermali_psu_info_get(int id, onlp_thermal_info_t* info)
-{   
+{
     int psu_present,psu_good;
     int psu_id,local_id;
     int r_data,temperature_v;
     enum ag7648_product_id pid;
-    
+
     local_id=id;
-    
+
     DEBUG_PRINT("\n[Debug][%s][%d][local_id: %d]", __FUNCTION__, __LINE__, local_id);
-    
+
     psu_id=(local_id-THERMAL_1_ON_PSU1)+1;
     pid=get_product_id();
     //if the psu is not, directly to return
@@ -177,7 +178,7 @@ _onlp_thermali_psu_info_get(int id, onlp_thermal_info_t* info)
 		return ONLP_STATUS_OK;
 	}
 
-    //read the pus temperture register value     
+    //read the psu temperture register value
     if(pid == PID_AG7648){
         if(psu_id==1)
             r_data=i2c_devname_read_word("PSU1_PMBUS", 0x8d);
@@ -203,14 +204,14 @@ _onlp_thermali_psu_info_get(int id, onlp_thermal_info_t* info)
 
 int
 onlp_thermali_info_get(onlp_oid_t id, onlp_thermal_info_t* info)
-{   
+{
     int rc;
     int local_id;
 
     VALIDATE(id);
 
     local_id=ONLP_OID_ID_GET(id);
-	
+
 	if((local_id > THERMAL_1_ON_PSU2) || (local_id < THERMAL_1_CLOSE_TO_CPU)){
 		DEBUG_PRINT("\n[Debug][%s][%d][outside addr:%d]", __FUNCTION__, __LINE__, local_id);
 		return ONLP_STATUS_E_INVALID;
@@ -223,6 +224,6 @@ onlp_thermali_info_get(onlp_oid_t id, onlp_thermal_info_t* info)
 		rc= _onlp_thermali_psu_info_get(local_id,info);
 	else
         rc= _onlp_thermali_info_get(local_id,info);
-    
+
 	return rc;
 }
-- 
2.20.1

